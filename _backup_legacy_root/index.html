<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>抽球动画 — 超几何分布步步讲解</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --text:#e6eef8;
    --muted:#9fb0c9;
    --accent:#6ee7b7;
  }
  body{
    margin:0;
    font-family: "PingFang SC","Microsoft YaHei",sans-serif;
    background:linear-gradient(180deg,var(--bg),#081023);
    color:var(--text);
    display:flex;
    min-height:100vh;
    align-items:center;
    justify-content:center;
    padding:20px;
    box-sizing:border-box;
  }

  .wrap{
    width:100%;
    max-width:1100px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    box-shadow:0 8px 30px rgba(2,6,23,0.7);
    padding:18px;
    display:flex;
    gap:18px;
  }

  .left{
    flex:1;
    min-width:360px;
  }

  .right{
    width:420px;
    max-width:45%;
    background: rgba(255,255,255,0.02);
    border-radius:10px;
    padding:14px;
    box-sizing:border-box;
    overflow:auto;
  }

  h2{margin:0 0 8px 0; font-size:18px}
  p.muted{color:var(--muted); margin:6px 0 12px 0; font-size:13px}

  /* 箱子与球 */
  .box{
    width:100%;
    height:360px;
    background:linear-gradient(180deg,#071226,#0b1530);
    border-radius:10px;
    position:relative;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.03);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    box-sizing:border-box;
  }

  .tray{
    width:86%;
    height:260px;
    background:linear-gradient(180deg,#072136,#042236);
    border-radius:8px;
    position:relative;
    box-shadow: inset 0 6px 20px rgba(0,0,0,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    gap:12px;
    padding:18px;
    box-sizing:border-box;
  }

  .ball{
    width:44px;
    height:44px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:700;
    box-shadow:0 6px 12px rgba(2,6,23,0.6);
    cursor:default;
    user-select:none;
  }
  .red{ background: linear-gradient(180deg,#ff4d6d,#d93b56); }
  .blue{ background: linear-gradient(180deg,#4da6ff,#2d86ff); }

  /* 抽取区域 */
  .draw-area{
    position:absolute;
    right:20px;
    top:14px;
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:flex-end;
  }
  .draw-slot{
    width:84px;
    height:84px;
    border-radius:10px;
    background:rgba(255,255,255,0.02);
    border:1px dashed rgba(255,255,255,0.03);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:var(--muted);
  }

  /* 控制 */
  .controls{
    margin-top:12px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  button{
    background:linear-gradient(180deg,#1f6f9f,#1a5f88);
    color:var(--text);
    border:none;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 6px 18px rgba(0,0,0,0.5);
  }
  button.secondary{
    background:linear-gradient(180deg,#23303c,#1a2228);
    color:var(--muted);
  }
  button:active{ transform:translateY(1px); }

  /* 公式与步骤区域 */
  .step{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    padding:10px;
    border-radius:8px;
    margin-bottom:10px;
  }
  .formula{
    font-family: "Courier New",monospace;
    background:rgba(0,0,0,0.15);
    padding:8px;
    border-radius:6px;
    color:#f0f7ff;
    overflow:auto;
    font-size:13px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
  }
  th,td{
    text-align:center;
    padding:6px 8px;
    border-bottom:1px dashed rgba(255,255,255,0.03);
    font-size:13px;
  }

  .small{font-size:12px;color:var(--muted)}
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700}
  .center{display:flex;gap:8px;align-items:center;justify-content:center}
  @media (max-width:880px){
    .wrap{flex-direction:column}
    .right{width:100%}
    .draw-area{position:static; flex-direction:row}
    .box{height:300px}
  }

  /* 抽取动画 */
  .moving{
    transition: transform 600ms cubic-bezier(.22,.9,.17,1), opacity 400ms;
    z-index:999;
    position:relative;
  }

</style>
</head>
<body>
<div class="wrap" role="main" aria-label="抽球动画演示">
  <div class="left">
    <h2>不放回抽取示意（3 红，5 蓝）</h2>
    <p class="muted">从 8 个球中不放回抽取 4 个，记随机变量 \(X\) 为抽到的红球个数。点击 “抽取下一球” 一步一步观察过程。</p>

    <div class="box" id="box">
      <div class="tray" id="tray" aria-hidden="false"></div>

      <div class="draw-area" id="drawArea" aria-hidden="false">
        <div class="draw-slot" id="slot1">1</div>
        <div class="draw-slot" id="slot2">2</div>
        <div class="draw-slot" id="slot3">3</div>
        <div class="draw-slot" id="slot4">4</div>
      </div>
    </div>

    <div class="controls">
      <button id="stepBtn">抽取下一球</button>
      <button id="autoBtn" class="secondary">自动抽取</button>
      <button id="resetBtn" class="secondary">重置</button>
      <button id="shuffleBtn" class="secondary">洗牌（顺序重随机）</button>
      <button id="showFormulaBtn">显示概率推导</button>
    </div>

    <div style="margin-top:12px" class="center">
      <div class="badge">已抽：<span id="drawnCount">0</span>/4</div>
      <div class="badge">当前红球数：<span id="redCount">0</span></div>
      <div class="badge">当前蓝球数：<span id="blueCount">0</span></div>
    </div>

  </div>

  <div class="right" aria-label="推导区域">
    <h2>概率逐步推导</h2>
    <p class="small">下面按步骤展开超几何分布的计算与化简（每一步可点击展开/隐藏）。</p>

    <div class="step" id="step1">
      <strong>1. 总体与随机变量定义</strong>
      <div class="small" style="margin-top:6px">
        总球数 \(N=8\)，红球数 \(K=3\)，蓝球数 \(N-K=5\)。从中抽取 \(n=4\) 个球（不放回）。随机变量 \(X\) 表示抽到的红球数（可能的取值为 0、1、2、3）。
      </div>
    </div>

    <div class="step" id="step2">
      <strong>2. 超几何分布通式</strong>
      <div class="formula" style="margin-top:8px;">
        \( \displaystyle P(X=k)=\dfrac{\binom{K}{k}\,\binom{N-K}{n-k}}{\binom{N}{n}} \)
        （其中 \( \binom{a}{b}\) 表示组合数）
      </div>
    </div>

    <div class="step" id="step3">
      <strong>3. 代入我们的数值（逐项）</strong>
      <div class="formula" id="calcArea" style="margin-top:8px;">

        <!-- JS 会动态填充这里 -->
        <div id="calcContent">点击“显示概率推导”按钮查看逐项代入与化简结果。</div>
      </div>
    </div>

    <div class="step" id="step4">
      <strong>4. 结果汇总</strong>
      <table>
        <thead>
          <tr><th>k</th><th>组合数（分子）</th><th>分数</th><th>小数≈</th></tr>
        </thead>
        <tbody id="resultTable">
          <!-- JS 填充 -->
        </tbody>
      </table>
      <div style="margin-top:8px" class="small">注意：分母 \(\binom{8}{4}=70\)。</div>
    </div>

  </div>
</div>

<script>
/*
  逻辑说明：
  - 初始球：3 红 (R)，5 蓝 (B)
  - 使用数组 balls = ['R','R','R','B','B','B','B','B']
  - shuffle 后展示在 tray
  - 点击 "抽取下一球" 会把顶部（随机）一个球移动到对应槽位（1..4），并更新计数显示
  - 有自动抽取（每 800ms）开关
  - "显示概率推导" 会把公式代入并显示结果（使用精确分数与小数）
*/

const tray = document.getElementById('tray');
const drawArea = document.getElementById('drawArea');
const stepBtn = document.getElementById('stepBtn');
const autoBtn = document.getElementById('autoBtn');
const resetBtn = document.getElementById('resetBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const showFormulaBtn = document.getElementById('showFormulaBtn');

const drawnCountEl = document.getElementById('drawnCount');
const redCountEl = document.getElementById('redCount');
const blueCountEl = document.getElementById('blueCount');

const calcContent = document.getElementById('calcContent');
const resultTable = document.getElementById('resultTable');

let balls = [];
let currentIndex = 0; // 指向下一次抽取的索引（洗牌后顺序）
let drawn = []; // 已抽出的球
let autoTimer = null;

function makeBalls(){
  balls = ['R','R','R','B','B','B','B','B'];
}

function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

function renderTray(){
  tray.innerHTML='';
  balls.forEach((b, idx)=>{
    const d = document.createElement('div');
    d.className = 'ball ' + (b==='R'?'red':'blue');
    d.textContent = b==='R'?'R':'B';
    d.dataset.idx = idx;
    tray.appendChild(d);
  });
}

function reset(){
  if(autoTimer){ clearInterval(autoTimer); autoTimer = null; autoBtn.textContent='自动抽取'; autoBtn.classList.add('secondary');}
  makeBalls();
  shuffleArray(balls);
  renderTray();
  drawn = [];
  currentIndex = 0;
  drawnCountEl.textContent = '0';
  redCountEl.textContent = '0';
  blueCountEl.textContent = '0';
  // 清空抽槽
  for(let i=1;i<=4;i++){
    document.getElementById('slot'+i).innerHTML = i;
  }
  calcContent.innerHTML = '点击“显示概率推导”按钮查看逐项代入与化简结果。';
  resultTable.innerHTML = '';
}

function animateDraw(){
  if(currentIndex >= balls.length || drawn.length >= 4) return;
  // 找到 tray 上第一个未抽的元素（根据 currentIndex）
  const ballEl = tray.querySelector('.ball[data-idx="'+currentIndex+'"]');
  const color = balls[currentIndex];
  // create clone to animate
  const clone = ballEl.cloneNode(true);
  clone.style.position='absolute';
  const rectTray = tray.getBoundingClientRect();
  const rectBox = document.getElementById('box').getBoundingClientRect();
  // initial position: compute offset relative to box
  const elRect = ballEl.getBoundingClientRect();
  clone.style.left = (elRect.left - rectBox.left) + 'px';
  clone.style.top = (elRect.top - rectBox.top) + 'px';
  clone.classList.add('moving');
  clone.style.width = elRect.width + 'px';
  clone.style.height = elRect.height + 'px';
  clone.style.margin = '0';
  document.getElementById('box').appendChild(clone);

  // target slot
  const slotId = 'slot' + (drawn.length+1);
  const slot = document.getElementById(slotId);
  const slotRect = slot.getBoundingClientRect();
  const targetLeft = (slotRect.left - rectBox.left) + (slotRect.width - elRect.width)/2;
  const targetTop = (slotRect.top - rectBox.top) + (slotRect.height - elRect.height)/2;

  // trigger move
  requestAnimationFrame(()=>{
    clone.style.transform = `translate(${targetLeft - (elRect.left - rectBox.left)}px, ${targetTop - (elRect.top - rectBox.top)}px) scale(1.05)`;
    clone.style.opacity = '0.98';
  });

  // after animation complete
  setTimeout(()=>{
    // put summary into slot (colored small ball)
    slot.innerHTML = '';
    const small = document.createElement('div');
    small.className = 'ball ' + (color==='R'?'red':'blue');
    small.style.width='54px'; small.style.height='54px';
    small.textContent = color==='R'?'R':'B';
    slot.appendChild(small);

    // update drawn
    drawn.push(color);
    currentIndex++;
    drawnCountEl.textContent = drawn.length.toString();
    const redCount = drawn.filter(x=>x==='R').length;
    const blueCount = drawn.filter(x=>x==='B').length;
    redCountEl.textContent = redCount;
    blueCountEl.textContent = blueCount;

    // remove clone
    clone.remove();

    // if drawn <4, keep tray but grey out used ball
    const usedEl = tray.querySelector('.ball[data-idx="'+(currentIndex-1)+'"]');
    if(usedEl) usedEl.style.opacity = '0.24';

    // 如果已经抽完 4 个，结果展示总结（本地）
    if(drawn.length === 4){
      showDrawSummary();
      if(autoTimer){ clearInterval(autoTimer); autoTimer=null; autoBtn.textContent='自动抽取'; autoBtn.classList.add('secondary'); }
    }
  }, 700);
}

function showDrawSummary(){
  const r = drawn.filter(x=>x==='R').length;
  const b = drawn.filter(x=>x==='B').length;
  // 在右侧结果表格下方附加一次当前实验的观测结果
  const extra = document.createElement('div');
  extra.className = 'small';
  extra.style.marginTop = '8px';
  extra.innerHTML = `<strong>本次观测：</strong>抽到红球 ${r} 个，蓝球 ${b} 个。（注意：单次实验的结果只是一次观测）`;
  document.getElementById('step4').appendChild(extra);
}

// 组合数计算函数（整数）
function C(n,k){
  if(k<0 || k>n) return 0;
  k = Math.min(k, n-k);
  let res = 1;
  for(let i=1;i<=k;i++){
    res = res * (n - k + i) / i;
  }
  return Math.round(res);
}

function showProbabilityDerivation(){
  // N=8, K=3, n=4
  const N=8, K=3, n=4;
  // 分母
  const denom = C(N,n); // 70
  const lines = [];
  lines.push(`<div>已知：总球数 N=${N}，红球 K=${K}，抽取 n=${n} 个（不放回）。</div>`);
  lines.push(`<div style="margin-top:8px">通式：<br><code>P(X=k)=C(K,k)·C(N-K,n-k) / C(N,n)</code></div>`);
  lines.push(`<div style="margin-top:8px">分母：C(8,4)=${denom}</div>`);
  const tableRows = [];
  const results = [];
  for(let k=0;k<=3;k++){
    const a = C(K,k);
    const b = C(N-K, n-k);
    const numerator = a*b;
    const frac = `${numerator}/${denom}`;
    const decimal = (numerator/denom);
    // 保留 6 位小数的显示
    const decStr = decimal.toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
    tableRows.push(`<tr><td>${k}</td><td>C(3,${k})·C(5,${4-k}) = ${a}·${b} = ${numerator}</td><td>${frac}</td><td>${decStr}</td></tr>`);
    results.push({k, numerator, decimal});
  }

  calcContent.innerHTML = lines.join('') + `<div style="margin-top:10px"><table style="width:100%;"><thead><tr><th>k</th><th>分子（组合数乘积）</th><th>分数</th><th>≈ 小数</th></tr></thead><tbody>` + tableRows.join('') + `</tbody></table></div>`;

  // 填充右侧汇总表格
  resultTable.innerHTML = '';
  results.forEach(r=>{
    const frac = `${r.numerator}/${denom}`;
    const decStr = (r.decimal).toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.k}</td><td>${r.numerator}</td><td>${frac}</td><td>${decStr}</td>`;
    resultTable.appendChild(tr);
  });

  // 另外展示可约分（化简）形式
  const simpl = document.createElement('div');
  simpl.className='small';
  simpl.style.marginTop='8px';
  simpl.innerHTML = `<strong>可约分结果：</strong>
    <div style="margin-top:6px">
      P(X=0)=5/70=1/14 ≈ 0.0714286；<br>
      P(X=1)=30/70=3/7 ≈ 0.4285714；<br>
      P(X=2)=30/70=3/7 ≈ 0.4285714；<br>
      P(X=3)=5/70=1/14 ≈ 0.0714286。
    </div>`;
  calcContent.appendChild(simpl);
}

// 绑定事件
stepBtn.addEventListener('click', ()=>{
  if(drawn.length >= 4) return;
  animateDraw();
});

autoBtn.addEventListener('click', ()=>{
  if(autoTimer){
    clearInterval(autoTimer);
    autoTimer = null;
    autoBtn.textContent = '自动抽取';
    autoBtn.classList.add('secondary');
    return;
  }
  autoBtn.textContent = '停止';
  autoBtn.classList.remove('secondary');
  autoTimer = setInterval(()=>{
    if(drawn.length >= 4){
      clearInterval(autoTimer);
      autoTimer = null;
      autoBtn.textContent = '自动抽取';
      autoBtn.classList.add('secondary');
      return;
    }
    animateDraw();
  }, 900);
});

resetBtn.addEventListener('click', reset);

shuffleBtn.addEventListener('click', ()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; autoBtn.textContent='自动抽取'; autoBtn.classList.add('secondary'); }
  shuffleArray(balls);
  renderTray();
});

showFormulaBtn.addEventListener('click', showProbabilityDerivation);

// 初始化
reset();
</script>
</body>
</html>
