<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>2048 - 小游戏乐园</title>
  <link rel="stylesheet" href="../../styles.css">
  <style>
    .wrap { max-width: 520px; margin: 16px auto; }
    .board { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .tile { aspect-ratio: 1/1; display:flex; align-items:center; justify-content:center; border-radius: 10px; font-weight: 800; font-size: 22px; }
    .hud { text-align:center; color: var(--muted); margin-top: 8px; }
  </style>
</head>
<body>
  <div class="game-page">
    <div class="game-header">
      <a class="back" href="../../">← 返回首页</a>
      <h2>2048</h2>
      <div class="game-actions"><button id="resetBtn">重开</button></div>
    </div>

    <div class="wrap">
      <div class="board" id="board"></div>
      <div class="hud"><span id="score">得分：0</span></div>
    </div>

    <div class="dpad" aria-label="方向控制">
      <div class="empty"></div><button id="up">▲</button><div class="empty"></div>
      <button id="left">◀</button><div class="empty"></div><button id="right">▶</button>
      <div class="empty"></div><button id="down">▼</button><div class="empty"></div>
    </div>
  </div>

  <script>
    const boardEl = document.getElementById('board');
    const scoreEl = document.getElementById('score');
    const resetBtn = document.getElementById('resetBtn');
    const SIZE = 4;
    let grid, score;

    function colors(v){
      const map = {
        0: 'rgba(255,255,255,.08)', 2: '#e9edf8', 4: '#dbe7ff', 8: '#ffd59e', 16: '#ffb86b', 32: '#ff9c6e',
        64: '#ff7a90', 128: '#8ef0a4', 256: '#6ea8fe', 512: '#8ac6ff', 1024: '#b79cff', 2048: '#ffd966'
      };
      return map[v] || '#ffd966';
    }

    function newGrid() { return Array.from({length: SIZE}, () => Array(SIZE).fill(0)); }

    function randomEmpty() {
      const empty = [];
      for (let r=0;r<SIZE;r++) for (let c=0;c<SIZE;c++) if (!grid[r][c]) empty.push([r,c]);
      if (!empty.length) return null;
      return empty[Math.floor(Math.random()*empty.length)];
    }

    function spawn() {
      const cell = randomEmpty(); if (!cell) return false;
      const [r,c] = cell; grid[r][c] = Math.random() < .9 ? 2 : 4; return true;
    }

    function setup() {
      grid = newGrid(); score = 0; spawn(); spawn(); render();
    }

    function render() {
      boardEl.innerHTML = '';
      for (let r=0;r<SIZE;r++) for (let c=0;c<SIZE;c++) {
        const v = grid[r][c];
        const div = document.createElement('div');
        div.className = 'tile';
        div.style.background = colors(v);
        div.style.color = v <= 4 ? '#0b1020' : '#0b1020';
        div.textContent = v || '';
        boardEl.appendChild(div);
      }
      scoreEl.textContent = `得分：${score}`;
    }

    function slide(row) {
      const arr = row.filter(v => v);
      for (let i=0;i<arr.length-1;i++) {
        if (arr[i] === arr[i+1]) { arr[i] *= 2; score += arr[i]; arr.splice(i+1,1); }
      }
      while (arr.length < SIZE) arr.push(0);
      return arr;
    }

    function rotateCW(mat){
      return mat[0].map((_, i) => mat.map(row => row[i]).reverse());
    }
    function rotateCCW(mat){
      return rotateCW(rotateCW(rotateCW(mat)));
    }
    function flipH(mat){ return mat.map(row => row.slice().reverse()); }

    function move(dir){
      // 0: left, 1: up, 2: right, 3: down
      let work = grid.map(r => r.slice());
      if (dir === 2) work = flipH(work);
      if (dir === 1) work = rotateCW(work);
      if (dir === 3) work = rotateCCW(work);

      const before = JSON.stringify(work);
      work = work.map(slide);
      if (JSON.stringify(work) === before) return;

      if (dir === 2) work = flipH(work);
      if (dir === 1) work = rotateCCW(work);
      if (dir === 3) work = rotateCW(work);

      grid = work; spawn(); render();
      if (isGameOver()) setTimeout(()=> alert('游戏结束'), 100);
    }

    function isGameOver(){
      // any empty
      for (let r=0;r<SIZE;r++) for (let c=0;c<SIZE;c++) if (!grid[r][c]) return false;
      // any mergeable neighbors
      for (let r=0;r<SIZE;r++) for (let c=0;c<SIZE;c++) {
        if (r+1<SIZE && grid[r][c]===grid[r+1][c]) return false;
        if (c+1<SIZE && grid[r][c]===grid[r][c+1]) return false;
      }
      return true;
    }

    // Keyboard
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') move(0);
      else if (e.key === 'ArrowUp') move(1);
      else if (e.key === 'ArrowRight') move(2);
      else if (e.key === 'ArrowDown') move(3);
      else if (e.key.toLowerCase() === 'r') setup();
    });

    // D-Pad
    document.getElementById('up').onclick = () => move(1);
    document.getElementById('down').onclick = () => move(3);
    document.getElementById('left').onclick = () => move(0);
    document.getElementById('right').onclick = () => move(2);

    // Touch swipe
    let start=null;
    boardEl.addEventListener('touchstart', (e)=>{ start = e.touches[0]; });
    boardEl.addEventListener('touchmove', (e)=>{ e.preventDefault(); }, { passive:false });
    boardEl.addEventListener('touchend', (e)=>{
      if (!start) return;
      const end = e.changedTouches[0];
      const dx = end.clientX - start.clientX; const dy = end.clientY - start.clientY;
      if (Math.abs(dx) > Math.abs(dy)) move(dx>0?2:0); else move(dy>0?3:1);
      start=null;
    });

    resetBtn.addEventListener('click', setup);

    setup();
  </script>
</body>
</html>